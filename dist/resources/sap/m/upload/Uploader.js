/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/m/library","sap/ui/core/Element","sap/ui/core/util/File","sap/ui/Device","sap/ui/core/Item","sap/m/upload/UploadSetItem","sap/m/upload/UploaderHttpRequestMethod"],function(e,t,a,o,r,s,d,p){"use strict";var n=p;var i=a.extend("sap.m.upload.Uploader",{metadata:{library:"sap.m",publicMethods:["uploadItem","terminateItem","downloadItem"],properties:{uploadUrl:{type:"string",defaultValue:null},downloadUrl:{type:"string",defaultValue:null},httpRequestMethod:{type:"sap.m.upload.UploaderHttpRequestMethod",defaultValue:n.Post}},events:{uploadStarted:{parameters:{item:{type:"sap.m.upload.UploadSetItem"}}},uploadProgressed:{parameters:{item:{type:"sap.m.upload.UploadSetItem"},loaded:{type:"int"},total:{type:"int"}}},uploadCompleted:{parameters:{item:{type:"sap.m.upload.UploadSetItem"}}},uploadAborted:{parameters:{item:{type:"sap.m.upload.UploadSetItem"}}}}}});i.prototype.init=function(){this._mRequestHandlers={}};i.uploadFile=function(e,t,a){var o=new window.XMLHttpRequest;var s=this.getHttpRequestMethod();return new Promise(function(d,p){o.open(s,t,true);if((r.browser.edge||r.browser.internet_explorer)&&e.type&&o.readyState===1){o.setRequestHeader("Content-Type",e.type)}if(a){a.forEach(function(e){o.setRequestHeader(e.getKey(),e.getText())})}o.onreadystatechange=function(){if(this.readyState===window.XMLHttpRequest.DONE){if(this.status===200){d(this)}else{p(this)}}};o.send(e)})};i.prototype.uploadItem=function(e,t){var a=new window.XMLHttpRequest,o=e.getFileObject(),s=this,d={xhr:a,item:e},p=this.getHttpRequestMethod(),n=e.getUploadUrl()||this.getUploadUrl();a.open(p,n,true);if((r.browser.edge||r.browser.internet_explorer)&&o.type&&a.readyState===1){a.setRequestHeader("Content-Type",o.type)}if(t){t.forEach(function(e){a.setRequestHeader(e.getKey(),e.getText())})}a.upload.addEventListener("progress",function(t){s.fireUploadProgressed({item:e,loaded:t.loaded,total:t.total,aborted:false})});a.onreadystatechange=function(){var t=s._mRequestHandlers[e.getId()];if(this.readyState===window.XMLHttpRequest.DONE&&!t.aborted){s.fireUploadCompleted({item:e})}};this._mRequestHandlers[e.getId()]=d;a.send(e.getFileObject());this.fireUploadStarted({item:e})};i.prototype.terminateItem=function(e){var t=this._mRequestHandlers[e.getId()],a=this;t.xhr.onabort=function(){t.aborted=false;a.fireUploadAborted({item:e})};t.aborted=true;t.xhr.abort()};i.prototype.downloadItem=function(a,s,p){var n=this.getDownloadUrl()||a.getUrl();if(r.browser.name==="sf"){p=false}if(!a.getUrl()){e.warning("Items to download do not have a URL.");return false}else if(p){var i=null,l=new window.XMLHttpRequest;l.open("GET",n);s.forEach(function(e){l.setRequestHeader(e.getKey(),e.getText())});l.responseType="blob";l.onload=function(){var e=a.getFileName(),t=d._splitFileName(e,false);i=l.response;o.save(i,t.name,t.extension,a.getMediaType(),"utf-8")};l.send();return true}else{t.URLHelper.redirect(n,true);return true}};return i});