/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/util/reflection/JsControlTreeModifier","sap/base/util/uid","sap/base/Log"],function(e,t,r){"use strict";var o={};o.CHANGE_TYPE_MOVE_FIELD="moveSimpleFormField";o.CHANGE_TYPE_MOVE_GROUP="moveSimpleFormGroup";o.sTypeTitle="sap.ui.core.Title";o.sTypeMTitle="sap.m.Title";o.sTypeToolBar="sap.m.Toolbar";o.sTypeOverflowToolBar="sap.m.OverflowToolbar";o.sTypeLabel="sap.m.Label";o.sTypeSmartLabel="sap.ui.comp.smartfield.SmartLabel";o.CONTENT_AGGREGATION="content";function n(e,t,r){for(var o=0;o<r.length;o++){var n=e.getControlType(r[o]);if(t.indexOf(n)===-1){if(e.getVisible(r[o])){return true}}else{return false}}}function a(e,t,r,o,a,l,i){if(n(t,l,r)){var p=a.view;var c=a.appComponent;var g=t.createControl("sap.ui.core.Title",c,p,i);t.setProperty(g,"text","");t.insertAggregation(o,"content",g,0,p);var v=e.getRevertData();v.createdTitleSelector=a.modifier.getSelector(g,a.appComponent);e.setRevertData(v)}return t.getAggregation(o,"content")}function l(e,t,r,o){var a;var l=-1;if(n(e,t,r)){l++}for(var i=0;i<r.length;i++){var p=e.getControlType(r[i]);if(t.indexOf(p)>-1){l++;if(l===o){a=r[i];break}}}return r.indexOf(a)}function i(e,t,r){if(t>=e.length||t===-1){return true}var n=r.getControlType(e[t]);return o.sTypeTitle===n||o.sTypeToolBar===n||o.sTypeMTitle===n||o.sTypeOverflowToolBar===n}function p(e,t,r,o){var n=0;for(n=t+1;n<r.length;++n){var a=e.getControlType(r[n]);if(o.indexOf(a)>-1){break}}return n-t}function c(e,t,r){return p(e,r,t,[o.sTypeTitle,o.sTypeMTitle,o.sTypeToolBar,o.sTypeOverflowToolBar,o.sTypeLabel,o.sTypeSmartLabel])}function g(e,t,o,n,a){if(!i(t,o,e)){r.error("Illegal argument. iIndex has to point to a Label.")}else{n=a?n+1:n;var l=0;var p=o;var g;while(p<t.length&&l<n){++l;g=c(e,t,p);p+=g}return p}}function v(e,t,r,o,n){var a=r;for(var l=0;l<n;l++){a.splice(o+l,0,e[t+l])}return a}function s(e){var t=e.getTitle();if(!t){t=e.getToolbar()}return t}function d(e,t,r){var n=s(t.element);var a=r.modifier.getSelector(e,r.appComponent);var l={elementSelector:r.modifier.getSelector(n,r.appComponent),source:{groupIndex:t.sourceIndex},target:{groupIndex:t.targetIndex}};return{changeType:o.CHANGE_TYPE_MOVE_GROUP,targetSelector:a,movedControl:n,movedElements:[l]}}function u(e,t,r,n,a){var l=a.modifier.getSelector(e,a.appComponent);var i=t.element.getLabel();var p=a.modifier.getSelector(i,a.appComponent);var c=s(n.parent);var g=s(r.parent);var v=a.modifier.getSelector(c,a.appComponent);var d=a.modifier.getSelector(g,a.appComponent);var u={elementSelector:p,source:{groupSelector:d,fieldIndex:t.sourceIndex},target:{groupSelector:v,fieldIndex:t.targetIndex}};return{changeType:o.CHANGE_TYPE_MOVE_FIELD,targetSelector:l,target:c,source:g,movedControl:i,movedElements:[u]}}function m(e,t,r,o,n){e.removeAllAggregation(t,r.CONTENT_AGGREGATION);for(var a=0;a<o.length;++a){e.insertAggregation(t,r.CONTENT_AGGREGATION,o[a],a,n)}}o.applyChange=function(e,t,n){var i=n.modifier;var s=n.view;var d=n.appComponent;var u,f;var T=e.getContent();var C=T.movedElements[0];var y=i.getAggregation(t,o.CONTENT_AGGREGATION);var S=y.map(function(e){return i.getSelector(e,d)});var E={content:S};e.setRevertData(E);if(e.getChangeType()===o.CHANGE_TYPE_MOVE_FIELD){var I=i.bySelector(C.elementSelector||C.element,d,s);var O=y.indexOf(I);var b=c(i,y,O);u=i.bySelector(C.target.groupSelector||C.target.groupId,d,s);var x=y.indexOf(u);var h=i.bySelector(C.source.groupSelector||C.source.groupId,d,s);var G=y.indexOf(h);var _=g(i,y,x,C.target.fieldIndex,G===x&&C.source.fieldIndex<C.target.fieldIndex);var A=c(i,y,_);f=y.slice();var N=f.slice(O,O+b);var w,P,D,F;if(O<_){w=f.slice(0,O);D=f.slice(O+b,_+A);F=f.slice(_+A,f.length);f=w.concat(D.concat(N.concat(F)))}else if(O>_){P=f.slice(0,_+A);D=f.slice(_+A,O);F=f.slice(O+b,f.length);f=P.concat(N.concat(D.concat(F)))}if(O!=_){m(i,t,o,f,s)}}else if(e.getChangeType()===o.CHANGE_TYPE_MOVE_GROUP){var L=[o.sTypeTitle,o.sTypeToolBar,o.sTypeMTitle,o.sTypeOverflowToolBar];var M=i.bySelector(C.elementSelector||C.element,d,s);if(C.target.groupIndex===0||!M){y=a(e,i,y,t,n,L,T.newControlId)}var R=M?y.indexOf(M):0;var B=l(i,L,y,C.target.groupIndex);u=y[B];var V=p(i,B,y,L);var H=p(i,R,y,L);f=y.slice();f.splice(R,H);B=f.indexOf(u);var Y=C.source.groupIndex<C.target.groupIndex?V:0;f=v(y,R,f,B+Y,H);m(i,t,o,f,s)}else{r.warning("Unknown change type detected. Cannot apply to SimpleForm")}return true};o.completeChangeContent=function(e,o,n){var a;var l=n.modifier;var i=n.view;var p=n.appComponent;var c=l.bySelector(o.selector,p,i);var g=o.movedElements;if(g.length>1){r.warning("Moving more than 1 Formelement is not yet supported.")}var v=g[0];v.element=sap.ui.getCore().byId(v.id);var s=Object.assign({},o.source);var m=Object.assign({},o.target);if(!m.parent){m.parent=sap.ui.getCore().byId(m.id)}if(!s.parent){s.parent=sap.ui.getCore().byId(s.id)}if(c&&v.element&&m.parent){if(o.changeType==="moveSimpleFormGroup"){a=d(c,v,n)}else if(o.changeType==="moveSimpleFormField"){a=u(c,v,s,m,n)}}else{r.error("Element not found. This may be caused by an unstable id!")}var f=e.getDefinition();f.content.targetSelector=a.targetSelector;f.content.movedElements=a.movedElements;f.content.newControlId=l.getSelector(i.createId(t()),p);if(a.source&&a.target){e.addDependentControl(a.source,"sourceParent",n);e.addDependentControl(a.target,"targetParent",n)}e.addDependentControl([a.movedControl],"movedElements",n)};o.revertChange=function(e,t,r){var n=r.modifier;var a=r.appComponent;var l=r.view;var i=e.getRevertData();var p=i.content;var c=p.map(function(e){return n.bySelector(e,a,l)});m(n,t,o,c,l);var g=i.createdTitleSelector;var v=r.modifier.bySelector(g,r.appComponent);if(v){v.destroy()}e.resetRevertData();return true};o.getChangeVisualizationInfo=function(t,r){var o=t.getContent().movedElements[0];var n=o.source.groupSelector;var a=t.getChangeType()==="moveSimpleFormGroup"?e.bySelector(o.elementSelector,r).getParent().getId():o.elementSelector;return{affectedControls:[a],dependentControls:[n&&n.id?n:t.getContent().targetSelector]}};return o},true);