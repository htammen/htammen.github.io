/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_ODataMetaModelUtils","sap/base/assert","sap/base/Log","sap/base/util/each","sap/base/util/isEmptyObject","sap/base/util/uid","sap/ui/base/EventProvider","sap/ui/core/cache/CacheManager","sap/ui/thirdparty/datajs","sap/ui/thirdparty/jquery"],function(t,e,a,i,n,r,s,o,p,f){"use strict";var y="sap.ui.model.odata.ODataMetadata",h="http://www.sap.com/Protocols/SAPData";var c=s.extend("sap.ui.model.odata.ODataMetadata",{constructor:function(t,e){s.apply(this,arguments);this.bLoaded=false;this.bFailed=false;this.mEntityTypes={};this.mRequestHandles={};this.sUrl=t;this.bAsync=e.async;this.sUser=e.user;this.bWithCredentials=e.withCredentials;this.sPassword=e.password;this.mHeaders=e.headers;this.sCacheKey=e.cacheKey;this.oLoadEvent=null;this.oFailedEvent=null;this.oMetadata=null;this.bMessageScopeSupported=false;this.mNamespaces=e.namespaces||{sap:"http://www.sap.com/Protocols/SAPData",m:"http://schemas.microsoft.com/ado/2007/08/dataservices/metadata","":"http://schemas.microsoft.com/ado/2007/06/edmx"};var i=this;this.pLoadedWithReject=new Promise(function(t,e){i.fnResolve=t;i.fnReject=e});this.pLoaded=this.pLoadedWithReject.catch(function(t){return new Promise(function(t,e){i.fnResolve=t})});function n(t){o.set(i.sCacheKey,JSON.stringify({metadata:i.oMetadata,params:t}))}function r(t){a.error("[ODataMetadata] initial loading of metadata failed");if(t&&t.message){a.error("Error: "+t.message)}}if(this.sCacheKey){o.get(this.sCacheKey).then(function(t){if(t){var e=JSON.parse(t);this.oMetadata=e.metadata;this._handleLoaded(this.oMetadata,e.params,false)}else{this._loadMetadata().then(n).catch(r)}}.bind(this)).catch(r)}else{this._loadMetadata().catch(r)}},metadata:{publicMethods:["getServiceMetadata","attachFailed","detachFailed","attachLoaded","detachLoaded","refresh"]}});c._returnsCollection=function(t){if(t&&t.returnType&&t.returnType.startsWith("Collection(")){return true}return false};c.prototype._setNamespaces=function(t){this.mNamespaces=t};c.prototype._handleLoaded=function(t,e,a){var i=[];this.oMetadata=this.oMetadata?this.merge(this.oMetadata,t,i):t;this.oRequestHandle=null;e.entitySets=i;this.fnResolve(e);if(this.bAsync&&!a){this.fireLoaded(this)}else if(!this.bAsync&&!a){this.bLoaded=true;this.bFailed=false;this.oLoadEvent=setTimeout(this.fireLoaded.bind(this,e),0)}};c.prototype._loadMetadata=function(t,e){var a=this;t=t||this.sUrl;var i=this._createRequest(t);return new Promise(function(t,n){var s;function o(n,r){if(!n||!n.dataServices){var s={message:"Invalid metadata document",request:i,response:r};f(s);return}a.sMetadataBody=r.body;a.oRequestHandle=null;var o={metadataString:a.sMetadataBody};var p=r.headers["Last-Modified"];if(p){o.lastModified=p}var y=r.headers["eTag"];if(y){o.eTag=y}a._handleLoaded(n,o,e);t(o)}function f(t){var i={message:t.message,request:t.request,response:t.response};if(t.response){i.statusCode=t.response.statusCode;i.statusText=t.response.statusText;i.responseText=t.response.body}if(s&&s.bSuppressErrorHandlerCall){return}if(a.bAsync){delete a.mRequestHandles[s.id]}n(i);a.fnReject(i);if(a.bAsync&&!e){a.fireFailed(i)}else if(!a.bAsync&&!e){a.bFailed=true;a.oFailedEvent=setTimeout(a.fireFailed.bind(a,i),0)}}s=p.request(i,o,f,p.metadataHandler);if(a.bAsync){s.id=r();a.mRequestHandles[s.id]=s}})};c.prototype.refresh=function(){return this._loadMetadata()};c.prototype.getServiceMetadata=function(){return this.oMetadata};c.prototype.isLoaded=function(){return this.bLoaded};c.prototype.loaded=function(t){return t?this.pLoadedWithReject:this.pLoaded};c.prototype.isFailed=function(){return this.bFailed};c.prototype.fireLoaded=function(t){this.bLoaded=true;this.bFailed=false;this.fireEvent("loaded",t);a.debug(this+" - loaded was fired");return this};c.prototype.attachLoaded=function(t,e,a){this.attachEvent("loaded",t,e,a);return this};c.prototype.detachLoaded=function(t,e){this.detachEvent("loaded",t,e);return this};c.prototype.fireFailed=function(t){this.bFailed=true;this.fireEvent("failed",t);return this};c.prototype.attachFailed=function(t,e,a){this.attachEvent("failed",t,e,a);return this};c.prototype.detachFailed=function(t,e){this.detachEvent("failed",t,e);return this};c.prototype._getEntityAssociationEnd=function(e,a){var i;if(!this._checkMetadataLoaded()){return null}this._mGetEntityAssociationEndCache=this._mGetEntityAssociationEndCache||{};i=e.namespace+"."+e.name+"/"+a;if(this._mGetEntityAssociationEndCache[i]===undefined){var n=e?t.findObject(e.navigationProperty,a):null,r=n?t.getObject(this.oMetadata.dataServices.schema,"association",n.relationship):null,s=r?t.findObject(r.end,n.toRole,"role"):null;this._mGetEntityAssociationEndCache[i]=s}return this._mGetEntityAssociationEndCache[i]};function u(t){var e={};for(var a=0;a<t.length;a++){var i=t[a];if(i.entityContainer){for(var n=0;n<i.entityContainer.length;n++){var r=i.entityContainer[n];if(r.entitySet){for(var s=0;s<r.entitySet.length;s++){if(r.entitySet[s].name!=null){e[r.entitySet[s].name]=r.entitySet[s]}}}}}}return e}c.prototype._findEntitySetByName=function(t){if(!this.mEntitySets){this.mEntitySets=u(this.oMetadata.dataServices.schema)}return this.mEntitySets[t]};c.prototype._getEntityTypeByPath=function(t){if(!t){e(undefined,"sPath not defined!");return null}if(this.mEntityTypes[t]){return this.mEntityTypes[t]}if(!this._checkMetadataLoaded()){return null}var a=t.replace(/^\/|\/$/g,""),i=a.split("/"),n=i.length,r,s,o,p,f=this;if(i[0].indexOf("(")!=-1){i[0]=i[0].substring(0,i[0].indexOf("("))}if(n>1){r=f._getEntityTypeByPath(i[0]);for(var y=1;y<i.length;y++){if(r){if(i[y].indexOf("(")!=-1){i[y]=i[y].substring(0,i[y].indexOf("("))}p=f._getEntityTypeByNavProperty(r,i[y]);if(p){r=p}o=r}}}else{s=this._splitName(this._getEntityTypeName(i[0]));o=this._getObjectMetadata("entityType",s.name,s.namespace);if(o){o.entityType=this._getEntityTypeName(i[0])}}if(!o){var h=i[i.length-1];var c=this._getFunctionImportMetadata(h,"GET");if(!c){c=this._getFunctionImportMetadata(h,"POST")}if(c&&c.entitySet){o=Object.assign({},this._getEntityTypeByPath(c.entitySet));if(o){o.entityType=this._getEntityTypeName(c.entitySet);o.isFunction=true}}}if(o){this.mEntityTypes[t]=o}return o};c.prototype._getEntityTypeByName=function(t){var a,i=this,n,r,s;if(!t){e(undefined,"sName not defined!");return null}s=this._splitName(t);r=s.namespace;n=s.name;if(!this._checkMetadataLoaded()){return null}if(this.mEntityTypes[t]){a=this.mEntityTypes[t]}else{f.each(this.oMetadata.dataServices.schema,function(e,s){if(s.entityType&&(!r||s.namespace===r)){f.each(s.entityType,function(e,r){if(r.name===n){a=r;i.mEntityTypes[t]=a;a.namespace=s.namespace;return false}})}})}return a};c.prototype._checkMetadataLoaded=function(){if(!this.oMetadata||n(this.oMetadata)){e(undefined,"No metadata loaded!");return false}return true};c.prototype._getAnnotation=function(t){var a,i,n,r,s,o,p;i=t.split("/#");r=i[1].split("/");if(!i[0]){s=this._getEntityTypeByName(r[0]);e(s,r[0]+" is not a valid EntityType");if(!s){return}o=i[1].substr(i[1].indexOf("/")+1);p=this._getPropertyMetadata(s,o);e(p,o+" is not a valid property path");if(!p){return}n=o.substr(o.indexOf(p.name));n=n.substr(n.indexOf("/")+1)}else{s=this._getEntityTypeByPath(i[0]);e(s,i[0]+" is not a valid path");if(!s){return}t=i[0].replace(/^\/|\/$/g,"");o=t;while(!p&&o.indexOf("/")>0){o=o.substr(o.indexOf("/")+1);p=this._getPropertyMetadata(s,o)}e(p,o+" is not a valid property path");if(!p){return}n=r.join("/")}a=this._getAnnotationObject(s,p,n);return a};c.prototype._getAnnotationObject=function(t,e,a){var i,n,r,s,o;if(!e){return}s=e;n=a.split("/");if(n[0].indexOf(".")>-1){return this._getV4AnnotationObject(t,e,n)}else{if(n.length>1){s=s[n[0]];if(!s&&e.extensions){for(var p=0;p<e.extensions.length;p++){var f=e.extensions[p];if(f.name==n[0]){s=f;break}}}a=n.splice(0,1);r=this._getAnnotationObject(t,s,n.join("/"))}else{if(n[0].indexOf("@")>-1){o=n[0].substr(1);i=o.split(":");r=s[i[0]];if(!r&&s.extensions){for(var p=0;p<s.extensions.length;p++){var f=s.extensions[p];if(f.name===i[1]&&f.namespace===this.mNamespaces[i[0]]){r=f.value;break}}}}else{i=n[0].split(":");r=s[i[0]];r=s[n[0]];if(!r&&s.extensions){for(var p=0;p<s.extensions.length;p++){var f=s.extensions[p];if(f.name===i[1]&&f.namespace===this.mNamespaces[i[0]]){r=f;break}}}}}}return r};c.prototype._getV4AnnotationObject=function(t,a,i){var n,r=[];if(i.length>1){e(i.length==1,"'"+i.join("/")+"' is not a valid annotation path");return}var s=t.namespace?t.namespace+".":"";s+=t.name+"/"+a.name;f.each(this.oMetadata.dataServices.schema,function(t,e){if(e.annotations){f.each(e.annotations,function(t,e){if(e.target===s&&!e.qualifier){r.push(e.annotation);return false}})}});if(r){f.each(r,function(t,e){f.each(e,function(t,e){if(e.term===i[0]){n=e}})})}return n};c.prototype._splitName=function(t){var e={};if(t){var a=t.lastIndexOf(".");e.name=t.substr(a+1);e.namespace=t.substr(0,a)}return e};c.prototype._getEntityTypeName=function(t){var e,a;if(t){a=this._findEntitySetByName(t);if(a){e=a.entityType}}return e};c.prototype._getObjectMetadata=function(t,e,a){var i;if(e&&a){f.each(this.oMetadata.dataServices.schema,function(n,r){if(r[t]&&r.namespace===a){f.each(r[t],function(t,a){if(a.name===e){i=a;i.namespace=r.namespace;return false}});return!i}})}return i};c.prototype.getUseBatch=function(){var t=false;f.each(this.oMetadata.dataServices.schema,function(e,a){if(a.entityContainer){f.each(a.entityContainer,function(e,a){if(a.extensions){f.each(a.extensions,function(e,a){if(a.name==="use-batch"&&a.namespace==="http://www.sap.com/Protocols/SAPData"){t=typeof a.value==="string"?a.value.toLowerCase()==="true":!!a.value;return false}})}})}});return t};c.prototype._getFunctionImportMetadataIterate=function(t,e){var a=[];i(this.oMetadata.dataServices.schema,function(n,r){if(r["entityContainer"]){i(r["entityContainer"],function(n,r){if(r["functionImport"]){i(r["functionImport"],function(i,n){if(t(n)){a.push(n);if(e){return false}}})}return!(e&&a.length===1)})}return!(e&&a.length===1)});return a};c.prototype._getFirstMatchingFunctionImportMetadata=function(t){var e=this._getFunctionImportMetadataIterate(t,true);return e.length===1?e[0]:null};c.prototype._getFunctionImportMetadataByName=function(t){if(t.indexOf("/")>-1){t=t.substr(t.indexOf("/")+1)}return this._getFunctionImportMetadataIterate(function(e){return e.name===t})};c.prototype._getFunctionImportMetadata=function(t,e){if(t.indexOf("/")>-1){t=t.substr(t.indexOf("/")+1)}return this._getFirstMatchingFunctionImportMetadata(function(a){return a.name===t&&a.httpMethod===e})};c.prototype._getEntityTypeByNavProperty=function(t,e){if(!t.navigationProperty){return undefined}for(var a=0;a<t.navigationProperty.length;++a){var i=t.navigationProperty[a];if(i.name===e){return this._getEntityTypeByNavPropertyObject(i)}}return undefined};c.prototype._getEntityTypeByNavPropertyObject=function(t){var e;var a=this._splitName(t.relationship);var i=this._getObjectMetadata("association",a.name,a.namespace);if(i){var n=i.end[0];if(n.role!==t.toRole){n=i.end[1]}var r=this._splitName(n.type);e=this._getObjectMetadata("entityType",r.name,r.namespace);if(e){e.entityType=n.type}}return e};c.prototype._getNavigationPropertyNames=function(t){var e=[];if(t.navigationProperty){f.each(t.navigationProperty,function(t,a){e.push(a.name)})}return e};c.prototype._getNavPropertyRefInfo=function(t,e){var a,n,r,s,o,p,f,y,h,c,u,d=this;i(t.navigationProperty,function(i,l){r=d._splitName(l.relationship);n=d._getObjectMetadata("association",r.name,r.namespace);if(!n||!n.referentialConstraint){return}p=n.referentialConstraint.dependent;h=n.end.find(function(t){return t.role===p.role});if(h.type!==t.namespace+"."+t.name){return}f=p.propertyRef.some(function(t){return t.name===e});if(!f){return}o=n.referentialConstraint.principal;y=o.role;s=d._getAssociationSetByAssociation(l.relationship);h=s.end.find(function(t){return t.role===y});c=h.entitySet;u=o.propertyRef.map(function(t){return t.name});a={name:l.name,entitySet:c,keys:u}});return a};c.prototype._getPropertyMetadata=function(t,e){var a,i=this;if(!t){return}e=e.replace(/^\/|\/$/g,"");var n=e.split("/");f.each(t.property,function(t,e){if(e.name===n[0]){a=e;return false}});if(n.length>1){if(!a){while(t&&n.length>1){t=this._getEntityTypeByNavProperty(t,n[0]);n.shift()}if(t){a=i._getPropertyMetadata(t,n[0])}}else if(!a.type.toLowerCase().startsWith("edm.")){var r=this._splitName(a.type);a=this._getPropertyMetadata(this._getObjectMetadata("complexType",r.name,r.namespace),n[1])}}return a};c.prototype.destroy=function(){delete this.oMetadata;var t=this;f.each(this.mRequestHandles,function(e,a){a.bSuppressErrorHandlerCall=true;a.abort();delete t.mRequestHandles[e]});if(!!this.oLoadEvent){clearTimeout(this.oLoadEvent)}if(!!this.oFailedEvent){clearTimeout(this.oFailedEvent)}s.prototype.destroy.apply(this,arguments)};c.prototype._fillElementCaches=function(){var t=this;if(this._entitySetMap||!this._checkMetadataLoaded()){return}this._entitySetMap={};this.oMetadata.dataServices.schema.forEach(function(e){(e.entityContainer||[]).forEach(function(e){(e.entitySet||[]).forEach(function(e){var a=t._getEntityTypeByName(e.entityType);a.__navigationPropertiesMap={};(a.navigationProperty||[]).forEach(function(t){a.__navigationPropertiesMap[t.name]=t});e.__entityType=a;t._entitySetMap[e.entityType]=e})})})};c.prototype._createRequest=function(t){var e={"sap-cancel-on-close":true},a={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()};f.extend(e,this.mHeaders,a);var i={headers:e,requestUri:t,method:"GET",user:this.sUser,password:this.sPassword,async:this.bAsync};if(this.bAsync){i.withCredentials=this.bWithCredentials}return i};c.prototype._getEntitySetByPath=function(t){var e;this._fillElementCaches();e=this._getEntityTypeByPath(t);if(e){return this._entitySetMap[e.entityType]}};c.prototype._addUrl=function(t){var e=[].concat(t);return Promise.all(e.map(function(t){return this._loadMetadata(t,true)},this))};c.prototype.merge=function(t,e,a){var i=this;if(this.mEntitySets){delete this.mEntitySets}f.each(t.dataServices.schema,function(t,n){f.each(e.dataServices.schema,function(t,e){if(e.namespace===n.namespace){if(e.entityType){if(!i.mEntityTypeNames){i.mEntityTypeNames={};n.entityType.map(function(t){i.mEntityTypeNames[t.name]=true})}n.entityType=!n.entityType?[]:n.entityType;for(var r=0;r<e.entityType.length;r++){if(!(e.entityType[r].name in i.mEntityTypeNames)){n.entityType.push(e.entityType[r]);i.mEntityTypeNames[e.entityType[r].name]=true}}}if(n.entityContainer&&e.entityContainer){f.each(n.entityContainer,function(t,n){f.each(e.entityContainer,function(t,e){if(e.entitySet){if(e.name===n.name){if(!i.mEntitySetNames){i.mEntitySetNames={};n.entitySet.map(function(t){i.mEntitySetNames[t.name]=true})}n.entitySet=!n.entitySet?[]:n.entitySet;for(var r=0;r<e.entitySet.length;r++){if(!(e.entitySet[r].name in i.mEntitySetNames)){n.entitySet.push(e.entitySet[r]);i.mEntitySetNames[e.entitySet[r].name]=true}}e.entitySet.forEach(function(t){a.push(t)})}}})})}if(e.annotations){n.annotations=!n.annotations?[]:n.annotations;n.annotations=n.annotations.concat(e.annotations)}}})});return t};c.prototype._getEntitySetByType=function(t){var e=t.namespace+"."+t.name;var a=this.oMetadata.dataServices.schema;for(var i=0;i<a.length;++i){var n=a[i].entityContainer;if(n){for(var r=0;r<n.length;++r){var s=n[r].entitySet;if(s){for(var o=0;o<s.length;++o){if(s[o].entityType===e){return s[o]}}}}}}return null};c.prototype._calculateCanonicalPath=function(t){var e,a,i,n;if(t){a=t.lastIndexOf(")");if(a!==-1){n=t.substr(0,a+1);var r=this._getEntitySetByPath(n);if(r){if(r.__entityType.isFunction){e=t}else{i=t.split("/");if(n==="/"+i[1]){if(!(i[2]in r.__entityType.__navigationPropertiesMap)){e=t}}else{i=n.split("/");n="/"+r.name+i[i.length-1].substr(i[i.length-1].indexOf("("))+t.substr(a+1);if(n!==t){e=n}}}}}}return e};c.prototype._getAssociationSetByAssociation=function(t){var e=this.oMetadata.dataServices.schema;for(var a=0;a<e.length;++a){var i=e[a].entityContainer;if(i){for(var n=0;n<i.length;++n){var r=i[n].associationSet;if(r){for(var s=0;s<r.length;++s){if(r[s].association===t){return r[s]}}}}}}return null};c.prototype._isMessageScopeSupported=function(){var t=this.oMetadata.dataServices.schema,e,a;if(!this.bMessageScopeSupported&&t){for(var i=0;i<t.length;++i){a=t[i].entityContainer;if(a){for(var n=0;n<a.length;++n){e=a[n];if(e.extensions&&Array.isArray(e.extensions)){for(var r=0;r<e.extensions.length;++r){if(e.extensions[r].name==="message-scope-supported"&&e.extensions[r].namespace===this.mNamespaces.sap){if(e.extensions[r].value==="true"){this.bMessageScopeSupported=true;break}}}}}}}}return this.bMessageScopeSupported};c.prototype._isCollection=function(t){var e=false;var a=t.lastIndexOf("/");if(a>0){var i=t.substring(0,a);var n=this._getEntityTypeByPath(i);if(n){var r=this._getEntityAssociationEnd(n,t.substring(a+1));if(r&&r.multiplicity==="*"){e=true}}}else{e=true}return e};c.prototype._getReducedPath=function(t){var e,a,i,n,r,s,o,p=t.split("/"),f;if(p.length<4){return t}this._fillElementCaches();for(a=1;a<p.length-2;a+=1){f=this._getEntityTypeByPath(p.slice(0,a+1).join("/"));r=f&&f.__navigationPropertiesMap[p[a+1].split("(")[0]];if(!r){continue}o=p[a+2].split("(")[0];n=this._getEntityTypeByNavPropertyObject(r);s=n&&n.__navigationPropertiesMap[o];if(!s||r.relationship!==s.relationship){continue}i=p[a+2].slice(o.length);e=this._getEntityAssociationEnd(n,o);if(e.multiplicity!=="*"||i&&p[a].endsWith(i)){p.splice(a+1,2);return this._getReducedPath(p.join("/"))}}return p.join("/")};c.prototype.getKeyPropertyNamesByPath=function(t){var e,a,i=t.lastIndexOf("/");if(i>0){a=this._getEntityTypeByPath(t.slice(0,i));if(a){e=this._getEntityAssociationEnd(a,t.slice(i+1).split("(")[0]);a=e?this._getEntityTypeByName(e.type):undefined}}else{a=this._getEntityTypeByPath(t)}if(a){return a.key.propertyRef.map(function(t){return t.name})}};c.prototype._getCanonicalPathOfFunctionImport=function(t,e){var i,n,r,s,o,p,f,h=t.extensions,u=t.returnType,d="",l=false;if(h){for(s=0;s<h.length;s+=1){if(h[s].name==="action-for"){i=h[s].value;break}}}if(c._returnsCollection(t)){l=true;u=u.slice(11,-1)}if(i){r=this._getEntityTypeByName(i)}else if(t.entitySet){r=this._getEntityTypeByPath(t.entitySet)}else if(u){r=this._getEntityTypeByName(u)}if(r){n=this._getEntitySetByType(r);if(n&&r.key&&r.key.propertyRef){if(l){return"/"+n.name}f=r.key.propertyRef;if(f.length===1){p=f[0].name;if(e[p]){d=e[p]}}else{o=[];for(s=0;s<f.length;s+=1){p=f[s].name;if(e[p]){o.push(p+"="+e[p])}}d=o.join(",")}return"/"+n.name+"("+d+")"}else if(!n){a.error("Cannot determine path of the entity set for the function import '"+t.name+"'",this,y)}else{a.error("Cannot determine keys of the entity type '"+r.entityType+"' for the function import '"+t.name+"'",this,y)}}return""};c.prototype._splitByLastNavigationProperty=function(t){var e,a,i,n,r,s=t.split("/"),o="/"+s[1],p=s.length;this._fillElementCaches();e=this._getEntityTypeByPath(o);for(a=2;a<p;a+=1){r=s[a];i=r.indexOf("(");if(i!==-1){r=r.slice(0,i)}if(e&&e.__navigationPropertiesMap[r]){n=a;e=this._getEntityTypeByNavProperty(e,r)}else{break}}if(n===undefined){return{pathBeforeLastNavigationProperty:t,lastNavigationProperty:"",addressable:true,pathAfterLastNavigationProperty:""}}return{pathBeforeLastNavigationProperty:s.slice(0,n).join("/"),lastNavigationProperty:"/"+s[n],addressable:this._isAddressable(e),pathAfterLastNavigationProperty:n+1>=p?"":"/"+s.slice(n+1).join("/")}};c.prototype._isAddressable=function(t){var e;if(!t){return true}e=this._entitySetMap[t.entityType];if(!e||!e.extensions){return true}return!e.extensions.some(function(t){return t.name==="addressable"&&t.namespace===h&&t.value==="false"})};return c});