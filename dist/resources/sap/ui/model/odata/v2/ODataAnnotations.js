/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/model/odata/AnnotationParser","sap/ui/base/EventProvider","sap/ui/core/cache/CacheManager","sap/base/assert","sap/ui/thirdparty/jquery"],function(e,t,r,a,o){"use strict";var n=t.extend("sap.ui.model.odata.v2.ODataAnnotations",{constructor:function(a,o){var n=this;t.apply(this,[o]);this._oMetadata=a;this._pLoaded=a.loaded();this._mCustomHeaders={};this._mAnnotations={};this._hasErrors=false;function i(e){if(!n._hasErrors){r.set(n.sCacheKey,JSON.stringify(e))}}if(!o||!o.skipMetadata){if(!o){o={}}if(!o.source){o.source=[]}else if(Array.isArray(o.source)){o.source=o.source.slice(0)}else{o.source=[o.source]}o.source.unshift({type:"xml",data:a.loaded().then(function(e){return{xml:e["metadataString"],lastModified:e["lastModified"],eTag:e["eTag"]}})})}if(o){this.sCacheKey=o.cacheKey;this.setHeaders(o.headers);if(this.sCacheKey){this._pLoaded=r.get(n.sCacheKey).then(function(t){var r;if(t){r=JSON.parse(t)}if(Array.isArray(r)){r.annotations={};r.forEach(function(t){e.restoreAnnotationsAtArrays(t.annotations);e.merge(r.annotations,t.annotations)});n._mAnnotations=r.annotations;n._fireSomeLoaded(r);n._fireLoaded(r);return r}else{return n.addSource(o.source).then(function(e){i(e);return e})}})}else{this._pLoaded=this.addSource(o.source)}}},metadata:{publicMethods:["getData","addSource","getHeaders","setHeaders","attachSuccess","detachSuccess","attachError","detachError","attachLoaded","detachLoaded","attachFailed","detachFailed"]}});n.prototype.getData=function(){return this._mAnnotations};n.prototype.getAnnotationsData=function(){return this._mAnnotations};n.prototype.getHeaders=function(){return o.extend({},this._mCustomHeaders)};n.prototype.setHeaders=function(e){this._mCustomHeaders=o.extend({},e)};n.prototype.loaded=function(){return this._pLoaded};n.prototype.addSource=function(e){if(!e||Array.isArray(e)&&e.length===0){return this._oMetadata.loaded()}if(!Array.isArray(e)){e=[e]}var t=this;var r=e.map(function(e){e=typeof e==="string"?{type:"url",data:e}:e;return t._loadSource(e).then(t._parseSourceXML).then(t._parseSource.bind(t)).catch(function(e){return e})});return Promise.all(r).then(function(e){return e.map(function(e){try{e=t._mergeSource(e);t._fireSuccess(e)}catch(r){t._fireError(e)}return e})}).then(function(e){e.annotations=t.getData();var r=e.filter(function(e){return e instanceof Error});if(r.length>0){t._hasErrors=true;if(r.length!==e.length){t._fireSomeLoaded(e);t._fireFailed(e)}else{t._fireFailed(e);t._fireAllFailed(e);return Promise.reject(e)}}else{t._fireSomeLoaded(e);t._fireLoaded(e)}return e})};n.prototype.attachSuccess=function(e,t,r){return this.attachEvent("success",e,t,r)};n.prototype.detachSuccess=function(e,t){return this.detachEvent("success",e,t)};n.prototype.attachError=function(e,t,r){return this.attachEvent("error",e,t,r)};n.prototype.detachError=function(e,t){return this.detachEvent("error",e,t)};n.prototype.attachLoaded=function(e,t,r){return this.attachEvent("loaded",e,t,r)};n.prototype.detachLoaded=function(e,t){return this.detachEvent("loaded",e,t)};n.prototype.attachFailed=function(e,t,r){return this.attachEvent("failed",e,t,r)};n.prototype.detachFailed=function(e,t){return this.detachEvent("failed",e,t)};n.prototype.attachSomeLoaded=function(e,t,r){return this.attachEvent("someLoaded",e,t,r)};n.prototype.detachSomeLoaded=function(e,t){return this.detachEvent("someLoaded",e,t)};n.prototype.attachAllFailed=function(e,t,r){return this.attachEvent("allFailed",e,t,r)};n.prototype.detachAllFailed=function(e,t){return this.detachEvent("allFailed",e,t)};n.prototype._fireSuccess=function(e){return this.fireEvent("success",{result:e},false,false)};n.prototype._fireError=function(e){return this.fireEvent("error",{result:e},false,false)};n.prototype._fireLoaded=function(e){return this.fireEvent("loaded",{result:e},false,false)};n.prototype._fireFailed=function(e){return this.fireEvent("failed",{result:e},false,false)};n.prototype._fireSomeLoaded=function(e){return this.fireEvent("someLoaded",{result:e},false,false)};n.prototype._fireAllFailed=function(e){return this.fireEvent("allFailed",{result:e},false,false)};n.prototype._loadSource=function(e){if(e.data instanceof Promise){return e.data.then(function(t){delete e.data;e.type="xml";e.xml=t.xml;e.lastModified=t.lastModified;e.eTag=t.eTag;return this._loadSource(e)}.bind(this))}else if(e.type==="xml"){if(typeof e.data==="string"){e.xml=e.data;delete e.data}return Promise.resolve(e)}else if(e.type==="url"){return this._loadUrl(e)}else{var t=new Error('Unknown source type: "'+e.type+'"');t.source=e;return Promise.reject(t)}};n.prototype._loadUrl=function(e){a(e.type==="url",'Source type must be "url" in order to be loaded');return new Promise(function(t,r){var a={url:e.data,async:true,headers:this._getHeaders(),beforeSend:function(e){e.overrideMimeType("text/plain")}};var n=function(r,a,o){e.xml=o.responseText;if(o.getResponseHeader("Last-Modified")){e.lastModified=new Date(o.getResponseHeader("Last-Modified"))}if(o.getResponseHeader("eTag")){e.eTag=o.getResponseHeader("eTag")}t(e)};var i=function(t,a){var o=new Error('Could not load annotation URL: "'+e.data+'"');o.source=e;r(o)};o.ajax(a).done(n).fail(i)}.bind(this))};n.prototype._parseSourceXML=function(e){a(typeof e.xml==="string","Source must contain XML string in order to be parsed");return new Promise(function(t,r){var a=(new DOMParser).parseFromString(e.xml,"application/xml");if(a.getElementsByTagName("parsererror").length>0){var o=new Error("There were errors parsing the XML.");o.source={type:e.type,data:e.data,xml:e.xml,document:a};r(o)}else{e.document=a;t(e)}})};n.prototype._parseSource=function(t){return this._oMetadata.loaded().then(function(){t.annotations=e.parse(this._oMetadata,t.document,t.data);delete t.document;return t}.bind(this))};n.prototype._mergeSource=function(t){a(typeof t.annotations==="object","Source must contain an annotation object to be merged");e.merge(this._mAnnotations,t.annotations);return t};n.prototype._getHeaders=function(){return o.extend({"sap-cancel-on-close":true},this.getHeaders(),{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()})};return n});