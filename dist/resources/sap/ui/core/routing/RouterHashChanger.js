/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./HashChangerBase"],function(e){"use strict";var t=e.extend("sap.ui.core.routing.RouterHashChanger",{constructor:function(t){if(!t||!t.parent){throw new Error("sap.ui.core.routing.RouterHashChanger can't be instantiated without a parent")}this.parent=t.parent;this.hash=t.hash||"";this.subHashMap=t.subHashMap;this.key=t.key||"";e.apply(this)}});t.InvalidHash=Object.create(null);t.prototype.init=function(){this.parent.init()};t.prototype._generatePrefixedKey=function(e){return this.key?this.key+"-"+e:e};t.prototype.createSubHashChanger=function(e){this.children=this.children||{};var h=this._generatePrefixedKey(e);if(this.children[h]){return this.children[h]}var i=new t({key:h,parent:this,subHashMap:this.subHashMap,hash:this.subHashMap&&this.subHashMap[h]||""});i.attachEvent("hashSet",this._onChildHashChanged.bind(this,h));i.attachEvent("hashReplaced",this._onChildHashChanged.bind(this,h));this.children[h]=i;return i};t.prototype.fireHashChanged=function(e,t,h){var i,s=this.hash;this.hash=e;this.subHashMap=t;if(!h&&e!==s){this.fireEvent("hashChanged",{newHash:e,oldHash:s})}if(this.children){i=Object.keys(this.children);i.forEach(function(e){var i=t[e]===undefined?"":t[e];this.children[e].fireHashChanged(i,t,h)}.bind(this))}};t.prototype._onChildHashChanged=function(e,t){var h=t.getParameter("key")||e,i=t.getParameter("hash"),s=t.getParameter("nestedHashInfo"),n=t.getParameter("deletePrefix");if(this._bCollectMode){this._collectHash(h,i,n)}else{this.fireEvent(t.getId(),{hash:i,key:h,nestedHashInfo:s,deletePrefix:n})}};t.prototype._collectHash=function(e,t,h){this._aCollectedHashInfo=this._aCollectedHashInfo||[];this._aCollectedHashInfo.push({key:e,hash:t,deletePrefix:h})};t.prototype._hasRouterAttached=function(){return this.hasListeners("hashChanged")};t.prototype._collectActiveDescendantPrefix=function(){if(this.children){var e=Object.keys(this.children);return e.reduce(function(e,t){var h=this.children[t];if(h._hasRouterAttached()){e.push(t);Array.prototype.push.apply(e,h._collectActiveDescendantPrefix())}return e}.bind(this),[])}else{return[]}};t.prototype.getHash=function(){if(this._isUnderCollectMode()){return t.InvalidHash}else{return this.hash}};t.prototype._setActiveRouter=function(e){if(e.getHashChanger()===this){this._oActiveRouter=e}return this};t.prototype.resetHash=function(e){if(e&&this._oActiveRouter===e){this.hash=undefined}return this};t.prototype.setHash=function(e,t,h){if(!(t instanceof Promise)){h=t;t=null}return this._modifyHash(e,t,h)};t.prototype.replaceHash=function(e,t,h){if(!(t instanceof Promise)){h=t;t=null}return this._modifyHash(e,t,h,true)};t.prototype._modifyHash=function(e,t,h,i){var s,n=i?"hashReplaced":"hashSet",r=this;if(!h){s=this._collectActiveDescendantPrefix()}if(t){this._bCollectMode=true;return t.then(function(){r.fireEvent(n,{hash:e,nestedHashInfo:r._aCollectedHashInfo,deletePrefix:s});r._aCollectedHashInfo=null;r._bCollectMode=false})}else{this.fireEvent(n,{hash:e,deletePrefix:s})}};t.prototype._isUnderCollectMode=function(){return this.parent instanceof t&&this.parent._isInCollectMode()};t.prototype._isInCollectMode=function(){return this._bCollectMode||this.parent instanceof t&&this.parent._isInCollectMode()};t.prototype.destroy=function(){this.parent.deregisterRouterHashChanger(this);if(this.children){Object.keys(this.children).forEach(function(e){var t=this.children[e];t.destroy()}.bind(this));delete this.children}delete this.hash;delete this.subHashMap;delete this.parent;delete this.key;e.prototype.destroy.apply(this,arguments)};t.prototype.deregisterRouterHashChanger=function(e){if(this.children){Object.keys(this.children).some(function(t){var h=this.children[t];if(h===e){delete this.children[t];return true}}.bind(this))}};return t});