/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/test/_OpaLogger","sap/ui/thirdparty/jquery","sap/ui/test/selectors/_ControlSelectorValidator","sap/ui/test/selectors/_selectors"],function(e,t,r,n,o){"use strict";var a=e.extend("sap.ui.test.selectors._ControlSelectorGenerator");var i=t.getLogger("sap.ui.test.selectors._ControlSelectorGenerator");a._generate=function(e){var t=a._getOrderedGenerators(e.settings);var r=e.includeAll?a._executeAllPlainGenerators(t,e):a._executeTopPlainGenerator(t,e);return r.catch(function(t){if(e.shallow){return Promise.reject(t)}else{return a._generateHierarchicalUp(e.control).catch(function(){return a._generateHierarchicalDown(e.control)}).then(function(t){var r=a._filterUnique(t,e);return e.includeAll?r:r[0]})}})};var u=20;var c=10;a.setParams=function(e){if(e.maxDepth&&Number.isInteger(e.maxDepth)&&e.maxDepth>0){a._maxDepth=e.maxDepth}if(e.maxWidth&&Number.isInteger(e.maxWidth)&&e.maxWidth>0){a._maxWidth=e.maxWidth}};a.resetParams=function(e){a._maxDepth=u;a._maxWidth=c};a.resetParams();a._executeAllPlainGenerators=function(e,t){return Promise.all(e.map(function(e){return a._executeGenerator(e,t)})).then(function(e){e=e.filter(function(e){return e&&!r.isEmptyObject(e)&&(!Array.isArray(e)||e.length)});if(e.length){i.debug("The matching "+(t.multiple?"non-unique":"unique")+" selectors are: "+JSON.stringify(e));return e}else{return Promise.reject(new Error("Could not generate a selector for control "+t.control))}})};a._executeTopPlainGenerator=function(e,t,r){r=r||0;if(r===e.length){return Promise.reject(new Error("Could not generate a selector for control "+t.control))}return a._executeGenerator(e[r],t).then(function(n){if(n.length){i.debug("The top priority "+(t.multiple?"non-unique":"unique")+" selector is: "+JSON.stringify(n[0]));return n[0]}else{return a._executeTopPlainGenerator(e,t,r+1)}})};a._executeGenerator=function(e,t){return a._getValidationRootSelector(e,t).then(function(r){return a._getAncestorSelector(e,t).then(function(n){var o=e.generate(t.control,n,r);return a._filterUnique(o,t.validationRoot,t.multiple)})})};a._getValidationRootSelector=function(e,t){t=t||{};return new Promise(function(r,n){if(t.shallow||!e._isValidationRootRequired()){r(null)}else{var o=e._getValidationRoot(t.control);if(o){return a._generateUniqueSelectorInSubtree(t.control,o).then(function(e){r(e)}).catch(function(e){n(e)})}else{r(null)}}})};a._getAncestorSelector=function(e,t){t=t||{};return new Promise(function(r,n){if(t.shallow||!e._isAncestorRequired()){r(null)}else{var o=e._getAncestor(t.control);if(o){return a._generate({control:o}).then(function(e){r(e)}).catch(function(e){i.debug("Could not generate selector for ancestor "+o+". Error: "+e);r(null)})}else{r(null)}}})};a._generateHierarchicalUp=function(e){return a._generateUniqueAncestorSelector(e).then(function(t){return a._generateUniqueSelectorInSubtree(e,t.ancestor).then(function(e){return r.extend({},e,{ancestor:t.selector})})})};a._generateHierarchicalDown=function(e){return a._generate({control:e,shallow:true,multiple:true}).then(function(t){return a._generateUniqueDescendantSelector(e).then(function(e){return r.extend({},t,{descendant:e})})})};a._generateUniqueDescendantSelector=function(e,t){return new Promise(function(r,n){t=t||0;if(t>=a._maxDepth){n(new Error("Could not generate selector for descendant of "+e+". Exceeded limit of "+a._maxDepth+" levels"))}else{var o=Object.keys(e.mAggregations).filter(function(t){var r=e.mAggregations[t];return r&&(Array.isArray(r)&&r.length||r.getMetadata&&r.getMetadata().getName())}).map(function(t){var r=e.mAggregations[t];return Array.isArray(r)?r.slice(0,a._maxWidth):r}).reduce(function(e,t){return e.concat(t)},[]);return a._generateUniqueSelectorForChild(o).then(function(e){r(e)}).catch(function(){return a._callGenerateUniqueDescendant(o,t+1).then(function(e){r(e)}).catch(function(e){n(e)})})}})};a._callGenerateUniqueDescendant=function(e,t,r){r=r||0;if(r>=e.length){return Promise.reject(new Error("Could not generate unique selector for descendant at level "+t))}return a._generateUniqueDescendantSelector(e[r],t).then(function(e){return e}).catch(function(){return a._callGenerateUniqueDescendant(e,t,r+1)})};a._generateUniqueSelectorForChild=function(e,t){t=t||0;if(t>=e.length){return Promise.reject()}return a._generate({control:e[t],shallow:true}).then(function(e){return e}).catch(function(r){return a._generateUniqueSelectorForChild(e,t+1)})};a._generateUniqueAncestorSelector=function(e,t,r){t=t||e.getParent();r=r||0;var n=r>=a._maxDepth;if(!t||n){return Promise.reject(new Error("Could not generate unique selector for ancestor of "+e+(n?". Exceeded limit of "+a._maxDepth+" levels":"")))}return a._generate({control:t,shallow:true}).then(function(e){return{ancestor:t,selector:e}}).catch(function(n){i.debug("Could not generate selector for ancestor "+t+". Error: "+n);return a._generateUniqueAncestorSelector(e,t.getParent(),r+1)})};a._generateUniqueSelectorInSubtree=function(e,t){return a._generate({control:e,validationRoot:t,shallow:true})};a._filterUnique=function(e,t,r){var o=[];var a=new n(t,r);if(Array.isArray(e)){e.forEach(function(e){if(Array.isArray(e)){e.forEach(function(e){if(a._validate(e)){o.push(e)}})}else if(a._validate(e)){o.push(e)}})}else if(a._validate(e)){o.push(e)}return o};a._getOrderedGenerators=function(e){var t=["globalID","viewID","labelFor","bindingPath","properties","dropdownItem","tableRowItem","controlType"];if(e&&e.preferViewId){var r=t[0];t[0]=t[1];t[1]=r}return t.map(function(e){return o[e]})};return a});